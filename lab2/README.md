# Лабораторная работа 2

**Название:** "Разработка драйверов блочных устройств"

**Цель работы:** получить знания и навыки разработки драйверов блочных устройств для операционной системы Linux.

## Описание функциональности драйвера

Один первичный раздел размером 30Мбайт и один расширенный раздел, содержащий два логических раздела размером 10Мбайт каждый

## Инструкция по сборке

Сборка модуля:

```
make
```

Сборка с последующей установкой:

```
make install
```

Отключение модуля (если разделы диска были при монтированы — отмонтировать):

```
make uninstall
```

Очистка артефактов сборки:

```
make clean
```

## Инструкция пользователя


Получаем информацию о диске:


```console
# lsblk 
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
sda           8:0    0 125,8G  0 disk 
├─sda1        8:1    0     1M  0 part 
├─sda2        8:2    0   513M  0 part /boot/efi
└─sda3        8:3    0 125,3G  0 part /
sr0          11:0    1  50,6M  0 rom  /media/m/VBox_GAs_7.0.6
vramdisk    252:0    0    50M  0 disk 
├─vramdisk1 252:1    0    30M  0 part 
├─vramdisk2 252:2    0     1K  0 part 
├─vramdisk5 252:5    0    10M  0 part 
└─vramdisk6 252:6    0    10M  0 part 

# fdisk -l /dev/vramdisk
Диск /dev/vramdisk: 50 MiB, 52428800 байт, 102400 секторов
Единицы: секторов по 1 * 512 = 512 байт
Размер сектора (логический/физический): 512 байт / 512 байт
Размер I/O (минимальный/оптимальный): 512 байт / 512 байт
Тип метки диска: dos
Идентификатор диска: 0x36e5756d

Устр-во        Загрузочный начало  Конец Секторы Размер Идентификатор Тип
/dev/vramdisk1                  1  61439   61439    30M            83 Linux
/dev/vramdisk2              61440 102399   40960    20M             5 Расширенный
/dev/vramdisk5              61441  81919   20479    10M            83 Linux
/dev/vramdisk6              81921 102399   20479    10M            83 Linux
```

Создаём файловые системы в дисках:

```bash
mkfs.vfat /dev/vramdisk1
mkfs.vfat /dev/vramdisk5
mkfs.vfat /dev/vramdisk6
```

Монтируем их:

```bash
mkdir -p /mnt/vram1 && mount -t vfat /dev/vramdisk1 /mnt/vram1
mkdir -p /mnt/vram5 && mount -t vfat /dev/vramdisk5 /mnt/vram5
mkdir -p /mnt/vram6 && mount -t vfat /dev/vramdisk6 /mnt/vram6
```

Проверяем:

```console
# lsblk 
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
sda           8:0    0 125,8G  0 disk 
├─sda1        8:1    0     1M  0 part 
├─sda2        8:2    0   513M  0 part /boot/efi
└─sda3        8:3    0 125,3G  0 part /
sr0          11:0    1  50,6M  0 rom  /media/m/VBox_GAs_7.0.6
vramdisk    252:0    0    50M  0 disk 
├─vramdisk1 252:1    0    30M  0 part /mnt/vram1
├─vramdisk2 252:2    0     1K  0 part 
├─vramdisk5 252:5    0    10M  0 part /mnt/vram5
└─vramdisk6 252:6    0    10M  0 part /mnt/vram6
```


## Примеры использования

Создаём тестовые файлы на дисках:

```bash
fallocate -l 5M /mnt/vram1/file
fallocate -l 5M /mnt/vram5/file
fallocate -l 5M /mnt/vram6/file
```

Смотрим на скорость копирования между дисками (несколько раз):

```bash
pv /mnt/vram1/file > /mnt/vram6/file
pv /mnt/vram5/file > /mnt/vram6/file
pv /mnt/vram6/file > /mnt/vram1/file
```

```
5,00MiB 0:00:00 [ 940MiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 723MiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 688MiB/s] [===========================================================================================================>] 100%            

5,00MiB 0:00:00 [1011MiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 782MiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [1,00GiB/s] [===========================================================================================================>] 100%            

5,00MiB 0:00:00 [1,14GiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 854MiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 865MiB/s] [===========================================================================================================>] 100%            

5,00MiB 0:00:00 [1,08GiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 852MiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 645MiB/s] [===========================================================================================================>] 100% 
```

Смотрим на скорость копирования между дисками и хостовой машиной (несколько раз):
```bash
pv /mnt/vram1/file > /tmp/foo
pv /mnt/vram5/file > /tmp/foo
pv /mnt/vram6/file > /tmp/foo
```

```
5,00MiB 0:00:00 [1,12GiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [1,08GiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 864MiB/s] [===========================================================================================================>] 100%            

5,00MiB 0:00:00 [1,07GiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 837MiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 840MiB/s] [===========================================================================================================>] 100%            

5,00MiB 0:00:00 [ 915MiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 878MiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 664MiB/s] [===========================================================================================================>] 100%            

5,00MiB 0:00:00 [1,02GiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [ 688MiB/s] [===========================================================================================================>] 100%            
5,00MiB 0:00:00 [1,12GiB/s] [===========================================================================================================>] 100%
```
